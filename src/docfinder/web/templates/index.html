<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DocFinder</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      body {
        margin: 0;
        padding: 0 1.5rem;
        background: rgba(240, 240, 240, 0.85);
        color: #1f2933;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.5rem 0 1rem;
      }
      h1 {
        font-size: 1.6rem;
        margin: 0;
      }
      section {
        margin-bottom: 1.5rem;
        background: white;
        border-radius: 0.75rem;
        padding: 1.25rem;
        box-shadow: 0 6px 16px rgba(15, 23, 42, 0.06);
        border: 1px solid rgba(148, 163, 184, 0.18);
      }
      section h2 {
        margin: 0 0 0.75rem;
        font-size: 1.1rem;
      }
      form {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
      }
      input[type="text"] {
        flex: 1;
        padding: 0.6rem 0.9rem;
        border-radius: 0.5rem;
        border: 1px solid rgba(15, 23, 42, 0.2);
        font-size: 1rem;
      }
      button {
        padding: 0.6rem 1.1rem;
        border-radius: 0.5rem;
        border: none;
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
        cursor: pointer;
        font-weight: 600;
      }
      button:hover {
        background: linear-gradient(135deg, #1d4ed8, #1e40af);
      }
      ul {
        list-style: none;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .card {
        background: white;
        border-radius: 0.75rem;
        padding: 1rem 1.25rem;
        box-shadow: 0 10px 20px rgba(15, 23, 42, 0.08);
        border: 1px solid rgba(148, 163, 184, 0.2);
      }
      .path {
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        font-size: 0.85rem;
        color: #475569;
      }
      .score {
        font-weight: 600;
        color: #2563eb;
      }
      .actions {
        margin-top: 0.75rem;
        display: flex;
        gap: 0.5rem;
      }
      .secondary {
        background: transparent;
        color: #1d4ed8;
        border: 1px solid rgba(37, 99, 235, 0.4);
      }
      .secondary:hover {
        background: rgba(37, 99, 235, 0.1);
      }
      .metadata {
        font-size: 0.85rem;
        color: #6b7280;
        margin-top: 0.5rem;
      }
      .status {
        font-size: 0.9rem;
        color: #1f2933;
      }
      .status.error {
        color: #dc2626;
      }
      .status.success {
        color: #166534;
      }
      .snippet {
        margin-top: 0.75rem;
        font-size: 0.95rem;
        line-height: 1.4;
        color: #1f2933;
      }
      @media (max-width: 600px) {
        form {
          flex-direction: column;
        }
        button {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>DocFinder</h1>
      <button id="refresh" class="secondary" type="button">Clear results</button>
    </header>
    <section>
      <h2>Index folder or PDF</h2>
      <form id="index-form">
        <input
          id="index-path"
          type="text"
          placeholder="Absolute path to a folder or PDF file"
          required
        />
        <button type="submit">Index</button>
      </form>
      <div id="index-status" class="status" role="status" aria-live="polite"></div>
    </section>
    <form id="search-form">
      <input id="query" type="text" placeholder="Search your documents..." required />
      <button type="submit">Search</button>
    </form>
    <ul id="results"></ul>

    <script>
      const form = document.getElementById('search-form');
      const queryInput = document.getElementById('query');
      const resultsList = document.getElementById('results');
      const refreshButton = document.getElementById('refresh');
      const indexForm = document.getElementById('index-form');
      const indexInput = document.getElementById('index-path');
      const indexStatus = document.getElementById('index-status');

      const apiBase = window.location.origin;

      function resetStatus(element) {
        element.textContent = '';
        element.classList.remove('error', 'success');
      }

      function renderStats(stats) {
        const lines = [`Inserted: ${stats.inserted}`, `Updated: ${stats.updated}`, `Skipped: ${stats.skipped}`, `Failed: ${stats.failed}`];
        if (Array.isArray(stats.processed_files) && stats.processed_files.length > 0) {
          lines.push(`Processed files: ${stats.processed_files.length}`);
        }
        return lines.join(' Â· ');
      }

      function renderResult(result) {
        const li = document.createElement('li');
        li.className = 'card';

        const title = document.createElement('h2');
        title.textContent = result.title || result.path.split('/').pop();
        li.appendChild(title);

        const path = document.createElement('div');
        path.className = 'path';
        path.textContent = result.path;
        li.appendChild(path);

        const score = document.createElement('div');
        score.className = 'score';
        score.textContent = `Score: ${result.score.toFixed(4)}`;
        li.appendChild(score);

        if (result.metadata && Object.keys(result.metadata).length > 0) {
          const metadata = document.createElement('div');
          metadata.className = 'metadata';
          metadata.textContent = JSON.stringify(result.metadata);
          li.appendChild(metadata);
        }

        const snippet = document.createElement('div');
        snippet.className = 'snippet';
        snippet.textContent = result.text || '(senza estratto)';
        li.appendChild(snippet);

        const actions = document.createElement('div');
        actions.className = 'actions';

        const openButton = document.createElement('button');
  openButton.textContent = 'Open document';
        openButton.type = 'button';
        openButton.addEventListener('click', () => openDocument(result.path));
        actions.appendChild(openButton);

        li.appendChild(actions);
        return li;
      }

      async function performSearch(query) {
        const response = await fetch(`${apiBase}/search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query }),
        });
        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.detail || 'Search failed');
        }
        return response.json();
      }

      async function openDocument(path) {
        const response = await fetch(`${apiBase}/open`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path }),
        });
        if (!response.ok) {
          const data = await response.json();
          alert(data.detail || 'Unable to open the file');
        }
      }

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const query = queryInput.value.trim();
        if (!query) return;

        try {
          resultsList.innerHTML = '<li>Searching...</li>';
          const data = await performSearch(query);
          resultsList.innerHTML = '';
          if (data.results.length === 0) {
            resultsList.innerHTML = '<li>No results.</li>';
            return;
          }
          data.results.forEach((result) => {
            resultsList.appendChild(renderResult(result));
          });
        } catch (error) {
          resultsList.innerHTML = `<li style="color: #dc2626;">${error.message}</li>`;
        }
      });

      refreshButton.addEventListener('click', () => {
        resultsList.innerHTML = '';
        queryInput.value = '';
        queryInput.focus();
      });

      indexForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const targetPath = indexInput.value.trim();
        if (!targetPath) return;

        resetStatus(indexStatus);
  indexStatus.textContent = 'Indexing in progress...';

        try {
          const response = await fetch(`${apiBase}/index`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paths: [targetPath] }),
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.detail || 'Indexing failed');
          }
          indexStatus.classList.add('success');
          indexStatus.textContent = `Completed. ${renderStats(data.stats)}`;
          indexInput.value = '';
        } catch (error) {
          indexStatus.classList.add('error');
          indexStatus.textContent = error.message;
        }
      });
    </script>
  </body>
</html>
